# OpenTelemetry Trace ID Uniqueness Test

## Overview

This project is designed to test the uniqueness of trace IDs generated by the OpenTelemetry Node.js SDK under load. By combining a simple Node.js server instrumented with OpenTelemetry and the [Artillery](https://www.artillery.io/) load testing tool, you can simulate concurrent incoming requests and verify that each incoming request is assigned a unique trace ID. If a duplicate trace ID is ever detected, the server will immediately log the error and exit.

## Purpose

- **Validate Trace ID Uniqueness:** Ensures that the OpenTelemetry Node.js SDK reliably generates unique trace IDs for each incoming request, even under significant load and concurrency.
- **Stress Test Context Propagation:** Helps confirm that no race conditions or context mismanagement issues arise when handling thousands of requests per second.
- **Gather Data for Troubleshooting:** All output, including trace IDs for each request, is logged to a local file (`trace-results.log`) for post-run analysis.

## Prerequisites

- **Node.js v16+** (Tested with Node 20+)
- **NPM** (Installed with Node.js)
- **Artillery**: Installed locally via `npm install artillery` or run using `npx`.

## Files

- `server.js`: A Node.js server instrumented with a minimal OpenTelemetry setup. It records every incoming requestâ€™s trace ID and checks for duplicates.
- `artillery.yml`: The Artillery load test configuration file.
- `trace-results.log`: A log file that captures all request logs and a summary of the test results.

## Running the Test

1. **Install Dependencies**
   ```bash
   npm install
   ```

2. **Start the Server**
   ```bash
   node server.js
   ```
   The server will start on `http://localhost:3000` and will log output to both the console and `trace-results.log`.

3. **Run the Load Test**
   In another terminal window, run:
   ```bash
   npx artillery run artillery.yml
   ```
   This command will start sending concurrent HTTP requests to `http://localhost:3000` based on the configuration in `artillery.yml`.

4. **Observing Results**
   - If no duplicate trace IDs are found, the server will continue running. When you stop the server (using `Ctrl+C`), it will write a summary of the run to `trace-results.log`.
   - If a duplicate trace ID is detected at any point, the server will log an error, write the summary, and exit immediately.

## Configuring Concurrency in `artillery.yml`

In `artillery.yml`, the `phases` section controls load test behavior. For example:

```yaml
config:
  target: "http://localhost:3000"
  phases:
    - duration: 60
      arrivalRate: 100
scenarios:
  - flow:
    - get:
        url: "/"
```

- **`arrivalRate`**: The number of new virtual users (VUs) started per second. This directly correlates to requests per second, assuming each VU makes a single request.
- **`duration`**: The length of the test phase in seconds.

To increase concurrency (the number of requests happening at the same time), you can:

- Increase `arrivalRate`: A higher `arrivalRate` means more requests per second.
- Add multiple phases with different `arrivalRate` values or `rampTo` parameters to gradually increase concurrency.

Example of a more complex setup:

```yaml
config:
  target: "http://localhost:3000"
  phases:
    - duration: 30
      arrivalRate: 50     # 50 requests/second for first 30s
    - duration: 30
      arrivalRate: 100    # Increase to 100 requests/second for next 30s
    - duration: 30
      arrivalRate: 200    # Finally, 200 requests/second for last 30s
scenarios:
  - flow:
    - get:
        url: "/"
```

**Note:** Adjust these values based on how much load you want to apply and the capabilities of your testing environment.

## Analyzing the Results

- **Console Output & `trace-results.log`**: Check the console output and `trace-results.log` for incoming request lines showing `traceId` and `spanId`.  
- **Duplicate Detection**: If any line indicates `Duplicate traceId detected: ...`, review that moment in `trace-results.log`.  
- **Summary**: Upon server shutdown, a summary is appended to `trace-results.log` indicating total requests processed and whether any duplicates were encountered.

## Cleanup

- Stop the server (if still running) by pressing `Ctrl+C`.
- Delete `trace-results.log` if you want a clean slate before the next run.
